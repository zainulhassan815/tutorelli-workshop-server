<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Workshop Booking</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #fafafa;
      padding: 24px 0;
    }

    .form-container {
      max-width: 480px;
      margin: 0 auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 15px rgba(0, 0, 0, .08);
      padding: 30px 35px;
    }

    .form-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      text-align: center;
      margin-bottom: 20px;
    }

    /* Progress Steps */
    .progress-container {
      margin-bottom: 25px;
    }

    .progress-steps {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .step-circle {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #e0e0e0;
      color: #999;
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s, color 0.2s;
    }

    .step-circle.active,
    .step-circle.completed {
      background: #27ae60;
      color: #fff;
    }

    .step-connector {
      width: 60px;
      height: 3px;
      background: #e0e0e0;
      margin: 0 12px;
      transition: background-color 0.2s;
    }

    .step-connector.completed {
      background: #27ae60;
    }

    /* Form Steps */
    .form-step {
      display: none;
    }

    .form-step.active {
      display: block;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 16px;
      position: relative;
    }

    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #333;
      margin-bottom: 6px;
    }

    .required {
      color: #e74c3c;
    }

    .form-control {
      width: 100%;
      padding: 12px 14px;
      font-size: 14px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #fff;
      color: #333;
      transition: border-color 0.2s ease, opacity 0.2s ease;
    }

    .form-control:focus {
      outline: none;
      border-color: #4a90d9;
    }

    .form-control:disabled {
      background: #f7f7f7;
      color: #999;
      cursor: not-allowed;
    }

    .form-control.loading {
      opacity: 0.6;
    }

    select.form-control {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      padding-right: 35px;
    }

    select.form-control:disabled {
      cursor: not-allowed;
    }

    /* Form Row */
    .form-row {
      display: flex;
      gap: 15px;
    }

    .form-row .form-group {
      flex: 1;
    }

    /* Section Title */
    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: #444;
      margin: 20px 0 12px;
      padding-bottom: 6px;
      border-bottom: 1px solid #eee;
    }

    .section-title:first-child {
      margin-top: 0;
    }

    /* Status Messages */
    .field-status {
      font-size: 12px;
      margin-top: 5px;
      min-height: 18px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .field-status.loading {
      color: #888;
      font-style: italic;
    }

    .field-status.error {
      color: #e74c3c;
    }

    .field-status:empty {
      display: none;
    }

    .retry-btn {
      background: none;
      border: none;
      color: #3498db;
      text-decoration: underline;
      cursor: pointer;
      font-size: 12px;
      padding: 0;
      margin-left: 4px;
    }

    .retry-btn:hover {
      color: #2980b9;
    }

    /* Spinner */
    .spinner {
      width: 12px;
      height: 12px;
      border: 2px solid #ddd;
      border-top-color: #888;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Buttons */
    .button-group {
      display: flex;
      gap: 12px;
      margin-top: 25px;
    }

    .btn {
      flex: 1;
      padding: 13px 18px;
      font-size: 15px;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s ease, opacity 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #555;
    }

    .btn-secondary:hover {
      background: #e5e5e5;
    }

    .btn-primary {
      background: #3498db;
      color: #fff;
    }

    .btn-primary:hover:not(:disabled) {
      background: #2980b9;
    }

    .btn-primary:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
    }

    .btn .spinner {
      border-color: rgba(255, 255, 255, 0.3);
      border-top-color: #fff;
    }

    /* Submit Overlay */
    .submit-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      z-index: 1000;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
    }

    .submit-overlay.active {
      display: flex;
    }

    .submit-overlay .spinner {
      width: 40px;
      height: 40px;
      border-width: 4px;
    }

    .submit-overlay .status-text {
      font-size: 16px;
      color: #333;
      font-weight: 500;
    }

    /* Alert Messages */
    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
      display: none;
    }

    .alert.visible {
      display: block;
    }

    .alert-error {
      background: #fdecea;
      color: #c0392b;
      border: 1px solid #f5c6cb;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    /* Hidden Fields */
    .hidden-fields {
      display: none;
    }

    /* Responsive */
    @media (max-width: 520px) {
      .form-container {
        padding: 25px 20px;
        margin: 0 10px;
      }

      .form-row {
        flex-direction: column;
        gap: 0;
      }
    }
  </style>
</head>

<body>
  <div class="submit-overlay" id="submitOverlay">
    <div class="spinner"></div>
    <div class="status-text" id="submitStatus">Processing your booking...</div>
  </div>

  <div class="form-container">
    <h1 class="form-title">Workshop Booking</h1>

    <div class="alert alert-error" id="alertError"></div>
    <div class="alert alert-success" id="alertSuccess"></div>

    <div class="progress-container">
      <div class="progress-steps">
        <div class="step-circle active" data-step="1">1</div>
        <div class="step-connector" data-connector="1"></div>
        <div class="step-circle" data-step="2">2</div>
      </div>
    </div>

    <form id="workshopBookingForm" novalidate>
      <div class="form-step active" data-step-content="1">
        <div class="form-group">
          <label for="yearGroup">Year Group <span class="required">*</span></label>
          <select id="yearGroup" name="yearGroup" class="form-control" required>
            <option value="">-- Select Year Group --</option>
            <option value="gcse">GCSE</option>
            <option value="alevel">A Level</option>
          </select>
        </div>

        <div class="form-group">
          <label for="subject">Subject <span class="required">*</span></label>
          <select id="subject" name="subject" class="form-control" disabled required>
            <option value="">-- Select Subject --</option>
          </select>
          <div class="field-status" data-status="subject"></div>
        </div>

        <div class="form-group">
          <label for="workshopDate">Workshop Date <span class="required">*</span></label>
          <select id="workshopDate" name="workshopDate" class="form-control" disabled required>
            <option value="">-- Select Date --</option>
          </select>
          <div class="field-status" data-status="date"></div>
        </div>

        <div class="form-group">
          <label for="sessionTime">Session Time <span class="required">*</span></label>
          <select id="sessionTime" name="sessionTime" class="form-control" disabled required>
            <option value="">-- Select Time --</option>
          </select>
          <div class="field-status" data-status="time"></div>
        </div>

        <div class="button-group">
          <button type="button" class="btn btn-primary" id="nextToStep2" disabled>Continue</button>
        </div>
      </div>

      <div class="form-step" data-step-content="2">
        <div class="section-title">Parent/Guardian</div>

        <div class="form-row">
          <div class="form-group">
            <label for="parentFirstName">First Name <span class="required">*</span></label>
            <input type="text" id="parentFirstName" name="parentFirstName" class="form-control" required />
          </div>
          <div class="form-group">
            <label for="parentLastName">Last Name <span class="required">*</span></label>
            <input type="text" id="parentLastName" name="parentLastName" class="form-control" required />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="parentEmail">Email <span class="required">*</span></label>
            <input type="email" id="parentEmail" name="parentEmail" class="form-control" required />
          </div>
          <div class="form-group">
            <label for="parentPhone">Phone <span class="required">*</span></label>
            <input type="tel" id="parentPhone" name="parentPhone" class="form-control" required />
          </div>
        </div>

        <div class="section-title">Student</div>

        <div class="form-row">
          <div class="form-group">
            <label for="studentFirstName">First Name <span class="required">*</span></label>
            <input type="text" id="studentFirstName" name="studentFirstName" class="form-control" required />
          </div>
          <div class="form-group">
            <label for="studentLastName">Last Name <span class="required">*</span></label>
            <input type="text" id="studentLastName" name="studentLastName" class="form-control" required />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="studentEmail">Email <span class="required">*</span></label>
            <input type="email" id="studentEmail" name="studentEmail" class="form-control" required />
          </div>
          <div class="form-group">
            <label for="studentPhone">Phone <span class="required">*</span></label>
            <input type="tel" id="studentPhone" name="studentPhone" class="form-control" required />
          </div>
        </div>

        <div class="button-group">
          <button type="button" class="btn btn-secondary" id="backToStep1">Back</button>
          <button type="submit" class="btn btn-primary" id="submitBtn">Pay Now</button>
        </div>
      </div>

      <div class="hidden-fields">
        <input type="hidden" id="workshopOfferingId" name="workshopOfferingId" />
        <input type="hidden" id="intake" name="intake" />
        <input type="hidden" id="price" name="price" />
        <input type="hidden" id="offering" name="offering" />
        <input type="hidden" id="priceLabel" name="priceLabel" />
        <input type="hidden" id="zoomLink" name="zoomLink" />
      </div>
    </form>
  </div>

  <script>
    (function () {
      'use strict';

      // ============================================================
      // CONFIGURATION
      // ============================================================
      const CONFIG = {
        API_BASE_URL: 'https://services.leadconnectorhq.com',
        LOCATION_ID: 'zGBRMGnh4tB2Tssq6krd',
        ACCESS_TOKEN: 'pit-acb8c894-8e43-4472-9520-8314d160f217',

        // Custom Object Schema IDs
        WORKSHOP_OFFERINGS_SCHEMA: '697600eefd85aa50f9f0d508',
        BOOKINGS_SCHEMA: '697d329691208a590d9f01dd',

        OFFERING_FIELDS: {
          offering: 'offering',
          intake: 'intake',
          yearGroup: 'year_group',
          subject: 'subject',
          workshopDate: 'workshop_date',
          sessionTime: 'session_time',
          availability: 'availability',
          price: 'price',
          priceLabel: 'price_label',
          zoomLink: 'zoom_link'
        },

        BOOKING_FIELDS: {
          id: 'id',
          parentContactId: 'parent_contact_id',
          studentContactId: 'student_contact_id',
          workshopOfferingId: 'workshop_offering_id',
          paymentStatus: 'payment_status',
          pricePaid: 'price'
        },

        CONTACT_CUSTOM_FIELDS: {
          contactType: 'Y78OZFHJ5tVCNyVble9a',
          parentContactId: 'EAfs2UwBSmgNDU89Yhlj',
          yearGroup: '6VQA8CZUWQOGjq3yspkl'
        },

        AVAILABILITY: {
          AVAILABLE: 'available',
          FULL: 'full',
          INACTIVE: 'inactive'
        },

        PAGE_LIMIT: 100,
        REQUEST_TIMEOUT_MS: 15000,
        MAX_RETRIES: 2
      };

      // ============================================================
      // STATE
      // ============================================================
      const state = {
        yearGroup: null,
        subject: null,
        workshopDate: null,
        selectedOffering: null,
        offeringsCache: new Map(),
        currentRequestId: 0
      };

      // ============================================================
      // DOM ELEMENTS
      // ============================================================
      const elements = {
        form: document.getElementById('workshopBookingForm'),
        yearGroup: document.getElementById('yearGroup'),
        subject: document.getElementById('subject'),
        workshopDate: document.getElementById('workshopDate'),
        sessionTime: document.getElementById('sessionTime'),
        nextBtn: document.getElementById('nextToStep2'),
        backBtn: document.getElementById('backToStep1'),

        getStepContent: (n) => document.querySelector(`[data-step-content="${n}"]`),
        getStepCircle: (n) => document.querySelector(`[data-step="${n}"]`),
        getConnector: (n) => document.querySelector(`[data-connector="${n}"]`),
        getStatus: (type) => document.querySelector(`[data-status="${type}"]`)
      };

      // ============================================================
      // UTILITIES
      // ============================================================
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text ?? '';
        return div.innerHTML;
      }

      function formatDate(dateStr) {
        if (!dateStr || !/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr || '';
        const [y, m, d] = dateStr.split('-').map(Number);
        const date = new Date(y, m - 1, d);
        return date.toLocaleDateString('en-GB', {
          weekday: 'short', day: 'numeric', month: 'short', year: 'numeric'
        });
      }

      function parsePrice(priceField) {
        if (!priceField) return 0;
        if (typeof priceField === 'number') return priceField;
        if (typeof priceField === 'object' && priceField.value !== undefined) {
          return Number(priceField.value) || 0;
        }
        return parseFloat(priceField) || 0;
      }

      // ============================================================
      // UI HELPERS
      // ============================================================
      function setFieldStatus(type, status, message, retryFn) {
        const el = elements.getStatus(type);
        if (!el) return;

        el.className = 'field-status';
        el.innerHTML = '';

        if (status === 'loading') {
          el.classList.add('loading');
          el.innerHTML = `<span class="spinner"></span><span>${escapeHtml(message)}</span>`;
        } else if (status === 'error') {
          el.classList.add('error');
          el.innerHTML = escapeHtml(message);
          if (retryFn) {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'retry-btn';
            btn.textContent = 'Retry';
            btn.onclick = retryFn;
            el.appendChild(btn);
          }
        }
      }

      function clearFieldStatus(type) {
        const el = elements.getStatus(type);
        if (el) {
          el.className = 'field-status';
          el.innerHTML = '';
        }
      }

      function setSelectOptions(selectEl, options, placeholder) {
        selectEl.innerHTML = `<option value="">${escapeHtml(placeholder)}</option>`;
        for (const opt of options) {
          selectEl.insertAdjacentHTML('beforeend',
            `<option value="${escapeHtml(opt.value)}"${opt.disabled ? ' disabled style="color:#999;"' : ''}>${escapeHtml(opt.label)}</option>`
          );
        }
      }

      function updateContinueButton() {
        const canContinue = state.yearGroup && state.subject &&
          state.workshopDate && state.selectedOffering;
        elements.nextBtn.disabled = !canContinue;
      }

      function goToStep(step) {
        elements.getStepContent(1).classList.toggle('active', step === 1);
        elements.getStepContent(2).classList.toggle('active', step === 2);

        elements.getStepCircle(1).className = step === 1 ? 'step-circle active' : 'step-circle completed';
        elements.getStepCircle(2).className = step === 2 ? 'step-circle active' : 'step-circle';
        elements.getConnector(1).classList.toggle('completed', step === 2);
      }

      // ============================================================
      // RESET FUNCTIONS
      // ============================================================
      function resetSubject() {
        setSelectOptions(elements.subject, [], '-- Select Subject --');
        elements.subject.disabled = true;
        state.subject = null;
        clearFieldStatus('subject');
        resetDate();
      }

      function resetDate() {
        setSelectOptions(elements.workshopDate, [], '-- Select Date --');
        elements.workshopDate.disabled = true;
        state.workshopDate = null;
        clearFieldStatus('date');
        resetSession();
      }

      function resetSession() {
        setSelectOptions(elements.sessionTime, [], '-- Select Time --');
        elements.sessionTime.disabled = true;
        state.selectedOffering = null;
        clearFieldStatus('time');
        clearHiddenFields();
        updateContinueButton();
      }

      function clearHiddenFields() {
        document.getElementById('workshopOfferingId').value = '';
        document.getElementById('intake').value = '';
        document.getElementById('price').value = '';
        document.getElementById('offering').value = '';
        document.getElementById('priceLabel').value = '';
        document.getElementById('zoomLink').value = '';
      }

      // ============================================================
      // API FUNCTIONS
      // ============================================================
      async function fetchWithTimeout(url, options, timeoutMs) {
        const controller = new AbortController();
        const timer = setTimeout(() => controller.abort(), timeoutMs);
        try {
          const response = await fetch(url, { ...options, signal: controller.signal });
          return response;
        } finally {
          clearTimeout(timer);
        }
      }

      async function fetchOfferings(yearGroup, retryCount = 0) {
        const url = `${CONFIG.API_BASE_URL}/objects/${CONFIG.WORKSHOP_OFFERINGS_SCHEMA}/records/search`;

        const body = {
          locationId: CONFIG.LOCATION_ID,
          page: 1,
          pageLimit: CONFIG.PAGE_LIMIT,
          query: '',
          filters: [{
            group: 'AND',
            filters: [{
              group: 'AND',
              filters: [{
                field: `properties.${CONFIG.OFFERING_FIELDS.yearGroup}`,
                operator: 'eq',
                value: yearGroup
              }]
            }]
          }],
          sort: [{ field: 'updatedAt', direction: 'asc' }]
        };

        try {
          const response = await fetchWithTimeout(url, {
            method: 'POST',
            headers: {
              'Accept': 'application/json',
              'Version': '2021-07-28',
              'Authorization': `Bearer ${CONFIG.ACCESS_TOKEN}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(body)
          }, CONFIG.REQUEST_TIMEOUT_MS);

          if (!response.ok) {
            const text = await response.text().catch(() => '');
            throw new Error(`API error ${response.status}: ${text || response.statusText}`);
          }

          const data = await response.json();
          return (data.records || []).map(parseOfferingRecord);

        } catch (error) {
          if (retryCount < CONFIG.MAX_RETRIES) {
            await new Promise(r => setTimeout(r, 300 * (retryCount + 1)));
            return fetchOfferings(yearGroup, retryCount + 1);
          }
          throw error;
        }
      }

      function parseOfferingRecord(record) {
        const props = record?.properties || {};
        const F = CONFIG.OFFERING_FIELDS;
        return {
          id: record.id,
          offering: props[F.offering] || '',
          intake: props[F.intake] || '',
          yearGroup: props[F.yearGroup] || '',
          subject: props[F.subject] || '',
          workshopDate: props[F.workshopDate] || '',
          sessionTime: props[F.sessionTime] || '',
          availability: (props[F.availability] || '').toLowerCase(),
          price: parsePrice(props[F.price]),
          priceLabel: props[F.priceLabel] || '',
          zoomLink: props[F.zoomLink] || ''
        };
      }

      // ============================================================
      // CONTACT API FUNCTIONS
      // ============================================================
      async function findContactByEmail(email) {
        // Use GET endpoint with query parameter to search by email
        const params = new URLSearchParams({
          locationId: CONFIG.LOCATION_ID,
          query: email
        });

        const url = `${CONFIG.API_BASE_URL}/contacts/?${params.toString()}`;

        const response = await fetchWithTimeout(url, {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
            'Version': '2021-07-28',
            'Authorization': `Bearer ${CONFIG.ACCESS_TOKEN}`
          }
        }, CONFIG.REQUEST_TIMEOUT_MS);

        if (!response.ok) {
          const text = await response.text().catch(() => '');
          throw new Error(`Search contacts failed: ${response.status} - ${text}`);
        }

        const data = await response.json();
        const contacts = data.contacts || [];

        // Find exact email match
        return contacts.find(c =>
          c.email?.toLowerCase() === email.toLowerCase()
        ) || null;
      }

      async function createContact({ firstName, lastName, email, phone, tags = [], customFields = [] }) {
        const url = `${CONFIG.API_BASE_URL}/contacts/`;

        const body = {
          locationId: CONFIG.LOCATION_ID,
          firstName,
          lastName,
          name: `${firstName} ${lastName}`,
          email,
          phone,
          tags,
          source: 'Workshop Booking Form'
        };

        if (customFields.length > 0) {
          body.customFields = customFields;
        }

        const response = await fetchWithTimeout(url, {
          method: 'POST',
          headers: {
            'Accept': 'application/json',
            'Version': '2021-07-28',
            'Authorization': `Bearer ${CONFIG.ACCESS_TOKEN}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        }, CONFIG.REQUEST_TIMEOUT_MS);

        if (!response.ok) {
          const text = await response.text().catch(() => '');
          throw new Error(`Create contact failed: ${response.status} - ${text}`);
        }

        const data = await response.json();
        return data.contact;
      }

      async function updateContact(contactId, updates) {
        const url = `${CONFIG.API_BASE_URL}/contacts/${contactId}`;

        const response = await fetchWithTimeout(url, {
          method: 'PUT',
          headers: {
            'Accept': 'application/json',
            'Version': '2021-07-28',
            'Authorization': `Bearer ${CONFIG.ACCESS_TOKEN}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(updates)
        }, CONFIG.REQUEST_TIMEOUT_MS);

        if (!response.ok) {
          const text = await response.text().catch(() => '');
          throw new Error(`Update contact failed: ${response.status} - ${text}`);
        }

        const data = await response.json();
        return data.contact;
      }

      async function getOrCreateContact({ firstName, lastName, email, phone, tags = [], customFields = [] }) {
        // First, try to find existing contact
        const existing = await findContactByEmail(email);

        if (existing) {
          if (tags.length > 0) {
            const existingTags = existing.tags || [];
            const newTags = tags.filter(t => !existingTags.includes(t));

            if (newTags.length > 0) {
              await updateContact(existing.id, {
                tags: [...existingTags, ...newTags]
              });
            }
          }

          return existing;
        }

        return await createContact({ firstName, lastName, email, phone, tags, customFields });
      }

      // ============================================================
      // BOOKING API FUNCTIONS
      // ============================================================
      function generateBookingId() {
        const timestamp = Date.now().toString(36);
        const random = Math.random().toString(36).substring(2, 8);
        return `BK-${timestamp}-${random}`.toUpperCase();
      }

      async function createBookingRecord({ parentContactId, studentContactId, workshopOfferingId, pricePaid }) {
        if (!CONFIG.BOOKINGS_SCHEMA) return null;

        const url = `${CONFIG.API_BASE_URL}/objects/${CONFIG.BOOKINGS_SCHEMA}/records`;
        const F = CONFIG.BOOKING_FIELDS;
        const bookingId = generateBookingId();
        const properties = {};

        if (F.id) properties[F.id] = bookingId;
        if (F.parentContactId) properties[F.parentContactId] = parentContactId;
        if (F.studentContactId) properties[F.studentContactId] = studentContactId;
        if (F.workshopOfferingId) properties[F.workshopOfferingId] = workshopOfferingId;
        if (F.bookingDate) properties[F.bookingDate] = new Date().toISOString().split('T')[0];
        if (F.paymentStatus) properties[F.paymentStatus] = 'pending';
        if (F.pricePaid) properties[F.pricePaid] = pricePaid;

        const body = {
          locationId: CONFIG.LOCATION_ID,
          properties
        };

        const response = await fetchWithTimeout(url, {
          method: 'POST',
          headers: {
            'Accept': 'application/json',
            'Version': '2021-07-28',
            'Authorization': `Bearer ${CONFIG.ACCESS_TOKEN}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        }, CONFIG.REQUEST_TIMEOUT_MS);

        if (!response.ok) {
          const text = await response.text().catch(() => '');
          throw new Error(`Create booking failed: ${response.status} - ${text}`);
        }

        const data = await response.json();
        return data.record || data;
      }

      // ============================================================
      // DATA LOADING
      // ============================================================
      async function loadSubjects(yearGroup) {
        const requestId = ++state.currentRequestId;

        resetSubject();
        elements.subject.classList.add('loading');
        setFieldStatus('subject', 'loading', 'Loading subjects...');

        const retry = () => loadSubjects(yearGroup);

        try {
          let offerings = state.offeringsCache.get(yearGroup);

          if (!offerings) {
            offerings = await fetchOfferings(yearGroup);
            state.offeringsCache.set(yearGroup, offerings);
          }

          // Check if this request is still current
          if (requestId !== state.currentRequestId) return;

          const activeOfferings = offerings.filter(
            o => o.availability !== CONFIG.AVAILABILITY.INACTIVE
          );

          const subjects = [...new Set(activeOfferings.map(o => o.subject).filter(Boolean))]
            .sort((a, b) => a.localeCompare(b));

          if (subjects.length === 0) {
            setFieldStatus('subject', 'error', 'No subjects available for this year group.');
            return;
          }

          setSelectOptions(
            elements.subject,
            subjects.map(s => ({ value: s, label: s })),
            '-- Select Subject --'
          );

          elements.subject.disabled = false;
          clearFieldStatus('subject');

        } catch (error) {
          if (requestId === state.currentRequestId) {
            setFieldStatus('subject', 'error', 'Failed to load subjects.', retry);
          }
        } finally {
          elements.subject.classList.remove('loading');
        }
      }

      function loadDates(yearGroup, subject) {
        resetDate();

        const offerings = state.offeringsCache.get(yearGroup) || [];
        const activeOfferings = offerings.filter(
          o => o.subject === subject && o.availability !== CONFIG.AVAILABILITY.INACTIVE
        );

        const dates = [...new Set(activeOfferings.map(o => o.workshopDate).filter(Boolean))]
          .sort();

        if (dates.length === 0) {
          setFieldStatus('date', 'error', 'No dates available for this subject.');
          return;
        }

        setSelectOptions(
          elements.workshopDate,
          dates.map(d => ({ value: d, label: formatDate(d) })),
          '-- Select Date --'
        );

        elements.workshopDate.disabled = false;
      }

      function loadSessions(yearGroup, subject, workshopDate) {
        resetSession();

        const offerings = state.offeringsCache.get(yearGroup) || [];
        const sessions = offerings.filter(
          o => o.subject === subject &&
            o.workshopDate === workshopDate &&
            o.availability !== CONFIG.AVAILABILITY.INACTIVE
        ).sort((a, b) => (a.sessionTime || '').localeCompare(b.sessionTime || ''));

        if (sessions.length === 0) {
          setFieldStatus('time', 'error', 'No sessions available for this date.');
          return;
        }

        const options = sessions.map(o => {
          const isFull = o.availability === CONFIG.AVAILABILITY.FULL;
          const priceInfo = o.priceLabel ? ` — ${o.priceLabel}` : '';
          const label = `${o.sessionTime}${priceInfo}${isFull ? ' (Full)' : ''}`;

          return {
            value: isFull ? '' : o.id,
            label: label,
            disabled: isFull
          };
        });

        setSelectOptions(elements.sessionTime, options, '-- Select Time --');
        elements.sessionTime.disabled = false;
        elements.sessionTime._sessions = sessions;
      }

      // ============================================================
      // EVENT HANDLERS
      // ============================================================
      elements.yearGroup.addEventListener('change', function () {
        state.yearGroup = this.value || null;

        if (state.yearGroup) {
          loadSubjects(state.yearGroup);
        } else {
          resetSubject();
        }
      });

      elements.subject.addEventListener('change', function () {
        state.subject = this.value || null;

        if (state.subject) {
          loadDates(state.yearGroup, state.subject);
        } else {
          resetDate();
        }
      });

      elements.workshopDate.addEventListener('change', function () {
        state.workshopDate = this.value || null;

        if (state.workshopDate) {
          loadSessions(state.yearGroup, state.subject, state.workshopDate);
        } else {
          resetSession();
        }
      });

      elements.sessionTime.addEventListener('change', function () {
        const offeringId = this.value;

        if (!offeringId) {
          state.selectedOffering = null;
          clearHiddenFields();
          updateContinueButton();
          return;
        }

        const sessions = this._sessions || [];
        const offering = sessions.find(o => o.id === offeringId);

        if (!offering) {
          state.selectedOffering = null;
          clearHiddenFields();
          updateContinueButton();
          return;
        }

        state.selectedOffering = offering;
        document.getElementById('workshopOfferingId').value = offering.id;
        document.getElementById('intake').value = offering.intake;
        document.getElementById('price').value = String(offering.price);
        document.getElementById('offering').value = offering.offering;
        document.getElementById('priceLabel').value = offering.priceLabel;
        document.getElementById('zoomLink').value = offering.zoomLink;

        updateContinueButton();
      });

      elements.nextBtn.addEventListener('click', () => goToStep(2));
      elements.backBtn.addEventListener('click', () => goToStep(1));

      const submitOverlay = document.getElementById('submitOverlay');
      const submitStatus = document.getElementById('submitStatus');
      const alertError = document.getElementById('alertError');
      const alertSuccess = document.getElementById('alertSuccess');

      function showOverlay(message) {
        submitStatus.textContent = message;
        submitOverlay.classList.add('active');
      }

      function hideOverlay() {
        submitOverlay.classList.remove('active');
      }

      function showAlert(type, message) {
        alertError.classList.remove('visible');
        alertSuccess.classList.remove('visible');

        if (type === 'error') {
          alertError.textContent = message;
          alertError.classList.add('visible');
        } else {
          alertSuccess.textContent = message;
          alertSuccess.classList.add('visible');
        }
      }

      function hideAlerts() {
        alertError.classList.remove('visible');
        alertSuccess.classList.remove('visible');
      }

      elements.form.addEventListener('submit', async function (e) {
        e.preventDefault();

        if (!this.checkValidity()) {
          this.reportValidity();
          return;
        }

        const submitBtn = document.getElementById('submitBtn');
        hideAlerts();

        try {
          submitBtn.disabled = true;
          showOverlay('Processing your booking...');

          const offering = state.selectedOffering;
          const formData = {
            parent: {
              firstName: document.getElementById('parentFirstName').value.trim(),
              lastName: document.getElementById('parentLastName').value.trim(),
              email: document.getElementById('parentEmail').value.trim(),
              phone: document.getElementById('parentPhone').value.trim()
            },
            student: {
              firstName: document.getElementById('studentFirstName').value.trim(),
              lastName: document.getElementById('studentLastName').value.trim(),
              email: document.getElementById('studentEmail').value.trim(),
              phone: document.getElementById('studentPhone').value.trim()
            },
            workshop: {
              yearGroup: state.yearGroup,
              subject: state.subject,
              workshopDate: state.workshopDate,
              offeringId: offering?.id || '',
              intake: offering?.intake || '',
              sessionTime: offering?.sessionTime || '',
              price: offering?.price || 0,
              priceLabel: offering?.priceLabel || '',
              zoomLink: offering?.zoomLink || '',
              offering: offering?.offering || ''
            }
          };

          const workshopTag = `workshop-${state.yearGroup}-${state.subject}-${state.workshopDate}`.toLowerCase().replace(/\s+/g, '-');

          showOverlay('Setting up parent account...');

          const parentCustomFields = [];
          if (CONFIG.CONTACT_CUSTOM_FIELDS.contactType) {
            parentCustomFields.push({
              id: CONFIG.CONTACT_CUSTOM_FIELDS.contactType,
              field_value: 'parent'
            });
          }

          const parentContact = await getOrCreateContact({
            firstName: formData.parent.firstName,
            lastName: formData.parent.lastName,
            email: formData.parent.email,
            phone: formData.parent.phone,
            tags: ['parent', workshopTag],
            customFields: parentCustomFields
          });

          showOverlay('Setting up student profile...');

          const studentCustomFields = [];

          if (CONFIG.CONTACT_CUSTOM_FIELDS.contactType) {
            studentCustomFields.push({
              id: CONFIG.CONTACT_CUSTOM_FIELDS.contactType,
              field_value: 'student'
            });
          }

          if (CONFIG.CONTACT_CUSTOM_FIELDS.parentContactId) {
            studentCustomFields.push({
              id: CONFIG.CONTACT_CUSTOM_FIELDS.parentContactId,
              field_value: parentContact.id
            });
          }

          if (CONFIG.CONTACT_CUSTOM_FIELDS.yearGroup) {
            studentCustomFields.push({
              id: CONFIG.CONTACT_CUSTOM_FIELDS.yearGroup,
              field_value: state.yearGroup
            });
          }

          const studentContact = await getOrCreateContact({
            firstName: formData.student.firstName,
            lastName: formData.student.lastName,
            email: formData.student.email,
            phone: formData.student.phone,
            tags: ['student', workshopTag],
            customFields: studentCustomFields
          });

          let bookingRecord = null;

          if (CONFIG.BOOKINGS_SCHEMA) {
            showOverlay('Creating booking record...');

            bookingRecord = await createBookingRecord({
              parentContactId: parentContact.id,
              studentContactId: studentContact.id,
              workshopOfferingId: formData.workshop.offeringId,
              pricePaid: formData.workshop.price
            });

          }

          hideOverlay();
          const priceDisplay = formData.workshop.priceLabel || `£${formData.workshop.price}`;
          showAlert('success', `Booking created! Redirecting to payment (${priceDisplay})...`);

          // Determine checkout URL based on year group
          const checkoutUrls = {
            gcse: 'https://book.tutorelli.co.uk/checkout-gcse-year-11',
            alevel: 'https://book.tutorelli.co.uk/checkout-page-a-level-year-13'
          };

          const baseUrl = checkoutUrls[state.yearGroup];

          if (!baseUrl) {
            throw new Error(`No checkout URL configured for year group: ${state.yearGroup}`);
          }

          const checkoutParams = new URLSearchParams({
            parent_id: parentContact.id,
            student_id: studentContact.id,
            offering_id: formData.workshop.offeringId,
            subject: formData.workshop.subject,
            date: formData.workshop.workshopDate,
            time: formData.workshop.sessionTime,
            price: formData.workshop.price,
            email: formData.parent.email,
            phone: formData.parent.phone,
            name: `${formData.parent.firstName} ${formData.parent.lastName}`,
            student_name: `${formData.student.firstName} ${formData.student.lastName}`
          });

          if (bookingRecord?.id) {
            checkoutParams.set('booking_id', bookingRecord.id);
          }

          const checkoutUrl = `${baseUrl}?${checkoutParams.toString()}`;

          setTimeout(() => {
            window.location.href = checkoutUrl;
          }, 500);

        } catch (error) {
          hideOverlay();
          showAlert('error', `Booking failed: ${error.message}. Please try again.`);
        } finally {
          submitBtn.disabled = false;
        }
      });

    })();
  </script>
</body>

</html>